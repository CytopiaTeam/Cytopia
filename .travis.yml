language:              cpp
dist:                  xenial
sudo:                  required
group:                 edge

env:
  global:
    - GITHUB_REPO:     JimmySnails/Cytopia

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gcc-5
      - g++-5
      - ninja-build
      - doxygen
      - graphviz
      - libfreetype6-dev
      - libgl1-mesa-dev
      - libasound2-dev
      - libjack-dev
      - libpulse-dev
      - libaudio-dev

cache:
  timeout: 1000
  directories:
    - $HOME/.conan/

matrix:
  include:

    # gcc build
    - os:                linux
      name:              GCC 5 Build
      compiler:          gcc
      python:            3.7
      env:
        - C_COMPILER=gcc-5
      before_install:
        - sudo rm -rf /usr/local/cmake-3.9.2/
        - sudo rm -f /usr/local/cmake
        - sudo pip install cmake conan --ignore-installed

      install:
        - mkdir travis_build
        - cd travis_build
        - conan user

      script:
        # make sure CXX is correctly set
        - sudo unlink /usr/bin/gcc && sudo ln -s /usr/bin/gcc-5 /usr/bin/gcc
        - sudo unlink /usr/bin/g++ && sudo ln -s /usr/bin/g++-5 /usr/bin/g++
        - if [[ "${COMPILER}" != "" ]]; then export CXX=${COMPILER}; fi
        - if [[ "${C_COMPILER}" != "" ]]; then export CC=${COMPILER}; fi
        # Build Cytopia
        - cmake -GNinja -DCMAKE_BUILD_TYPE=Release ..
        - ninja
        - ldd ./bin/Cytopia
        - sh ../tools/CI/upload-CI-build.sh

      before_cache:
        - cmake -P ../cmake/pmm.cmake /Conan /Clean

    # clang build
    - os:                linux
      name:              CLANG 5 Build
      compiler:          clang
      python:            3.7
      env:
        - DEPLOY_DOCUMENTATION=true
        - COMPILER=clang++-5.0
        - CC=/usr/bin/gcc-5 /usr/bin/clang++-5.0
        - CXX=/usr/bin/gcc-5 /usr/bin/clang++-5.0

      before_install:
        - sudo rm -rf /usr/local/cmake-3.9.2/
        - sudo rm -f /usr/local/cmake
        - sudo pip install cmake conan --ignore-installed

      install:
        - mkdir travis_build
        - cd travis_build
        - conan user

      script:
        # Build Cytopia
        - cmake -GNinja -DCMAKE_BUILD_TYPE=Release ..
        - ninja
        - ninja doc

      before_cache:
        - cmake -P ../cmake/pmm.cmake /Conan /Clean

    - os:               osx
      name:             XCode 10.2 Build
      osx_image:        xcode10.2
      env:              TARGET=macOS
      language:         objective-c
      python:           3.7
      before_install:
        - brew update
        - brew install conan

      install:
        - mkdir travis_build
        - cd travis_build
        - conan user

      script:
        - cmake -DCMAKE_BUILD_TYPE=Release ..
        - make
        - make package

      before_cache:
        - cmake -P ../cmake/pmm.cmake /Conan /Clean

deploy:
  provider:            pages
  skip_cleanup:        true
  local_dir:           travis_build/html
  github_token:        $GH_REPO_TOKEN
  verbose:             true
  on:
    condition:         $DEPLOY_DOCUMENTATION = "true"
    branch:            master
